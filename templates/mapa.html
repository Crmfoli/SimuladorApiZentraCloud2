<script>
    // Centraliza o mapa na Tamoios (entre km 67 e km 82)
    var map = L.map('map').setView([-23.52, -45.58], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    // Sensores posicionados nos kms solicitados
    const sensores = [
        {
            id: 'SN-KM67',
            nome: 'Sensor KM 67',
            coords: [-23.5408, -45.5625]
        },
        {
            id: 'SN-KM72',
            nome: 'Sensor KM 72',
            coords: [-23.5255, -45.5722]
        },
        {
            id: 'SN-KM74',
            nome: 'Sensor KM 74',
            coords: [-23.5197, -45.5783]
        },
        {
            id: 'SN-KM82',
            nome: 'Sensor KM 82',
            coords: [-23.4955, -45.6009]
        }
    ];

    // Cria os marcadores no mapa
    sensores.forEach(sensor => {
        var marker = L.marker(sensor.coords).addTo(map);
        var popupContent = `<div style="text-align: center;">
                                <h4>${sensor.nome}</h4>
                                <p style="margin: 5px 0;">ID: ${sensor.id}</p>
                                <a href="/dashboard?device_id=${sensor.id}" class="btn-acessar">Ver Dados</a>
                            </div>`;
        marker.bindPopup(popupContent);
    });

    // Preenche a legenda
    const listaLegenda = document.getElementById('lista-sensores-legenda');
    sensores.forEach(sensor => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${sensor.nome}</span>
                        <span id="status-${sensor.id}">
                            <span class="status-dot"></span>Carregando...
                        </span>`;
        listaLegenda.appendChild(li);
    });

    // Função de risco (mantida)
    function analisarRisco(dados) {
        const umidade = dados.umidade;
        const chuva = dados.chuva;
        if (umidade > 48 && chuva > 3.0) return { nivel: "Iminente", classe: "status-iminente" };
        if (umidade > 50) return { nivel: "Alerta", classe: "status-alerta" };
        if (chuva > 5.0) return { nivel: "Alerta", classe: "status-alerta" };
        if (chuva > 0.5) return { nivel: "Atenção", classe: "status-atencao" };
        return { nivel: "Mínimo", classe: "status-minimo" };
    }

    async function atualizarLegendaStatus() {
        try {
            const response = await fetch('/api/status_sensores');
            const statusAtual = await response.json();
            const risco = analisarRisco(statusAtual);
            sensores.forEach(sensor => {
                const statusEl = document.getElementById(`status-${sensor.id}`);
                statusEl.innerHTML = `<span class="status-dot ${risco.classe}"></span>${risco.nivel}`;
            });
        } catch (error) {
            console.error("Erro ao atualizar status da legenda:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        atualizarLegendaStatus();
        setInterval(atualizarLegendaStatus, 5000);
    });
</script>






